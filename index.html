<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Regression SSE Surface</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<style>
  body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    height: 100vh;
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
  }
  .plot { width: 100%; height: 100%; }
  #functionWrapper { display: flex; flex-direction: row; align-items: stretch; width: 100%; height: 100%; }
  #leftSide { flex: 3; display: flex; flex-direction: column; }
  #function2D { flex: 1; width: 100%; }
  #controls { margin-top: 10px; }
  #rightSide { flex: 1; display: flex; flex-direction: column; margin-left: 15px; }
  button { margin: 5px 0; padding: 6px 12px; border-radius: 8px; border: none; background: #0077cc; color: white; cursor: pointer; }
  button:hover { background: #005fa3; }
  #tableWrapper { flex: 1; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 6px 10px; text-align: center; }
  th { background: #f0f0f0; position: sticky; top: 0; }
</style>
</head>
<body>

<div id="surfacePlot" class="plot"></div>

<div id="functionWrapper">
  <div id="leftSide">
    <div id="function2D"></div>
    <div id="controls">
      <button id="resetBtn">Reset Points</button>
      <button id="randomBtn">Generate 6 Random Points</button>
      <button id="showCurveBtn">Show Curve</button>
    </div>
  </div>
  <div id="rightSide">
    <div id="tableWrapper">
      <table id="pointsTable">
        <thead>
          <tr><th>#</th><th>x</th><th>y</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ---------------------------
  // 1. Choose function type
  // ---------------------------
  const forms = ["A*B^x", "A*x^B", "A*log(x)+B"];
  const chosen = forms[Math.floor(Math.random() * forms.length)];
  const A0 = (Math.random()*3+1).toFixed(2);
  const B0 = (Math.random()*3+1).toFixed(2);

  const exprStr = chosen.replace(/A/g,A0).replace(/B/g,B0);
  let g;
  if(chosen === "A*B^x") g = (a,b,x)=>a*Math.pow(b,x);
  else if(chosen === "A*x^B") g = (a,b,x)=>a*Math.pow(x,b);
  else g = (a,b,x)=>a*Math.log(x)+b;

  // ---------------------------
  // 2. Generate sample points
  // ---------------------------
  const xStart = chosen.includes("log(x)") ? 1 : 0;
  const xEnd = 10;
  let dataset = [];
  const nPoints = 6;
  const scale = 0.05;
  const minError = 0.1;

  function generatePoints() {
    dataset = [];
    for(let i=0;i<nPoints;i++){
      const x = Math.random()*(xEnd-xStart)+xStart;
      const trueY = g(parseFloat(A0),parseFloat(B0),x);
      const errMagnitude = Math.max(scale*Math.abs(trueY),minError);
      const y = trueY + (Math.random()-0.5)*2*errMagnitude;
      dataset.push({x,y});
    }
  }

  generatePoints();

  // ---------------------------
  // 3. 2D Plot with points (curve hidden initially)
  // ---------------------------
  const xLine = [];
  for(let x=xStart;x<=xEnd;x+=0.1) xLine.push(x);

  const yLine = xLine.map(x=>g(parseFloat(A0),parseFloat(B0),x));

  const funcTrace = {
    type:"scatter",
    mode:"lines",
    x:xLine,
    y:yLine,
    line:{color:"red"},
    name:`g(x) = ${exprStr}`,
    visible:false
  };

  const pointsTrace = {
    type:"scatter",
    mode:"markers",
    x:dataset.map(p=>p.x),
    y:dataset.map(p=>p.y),
    marker:{color:"black", size:8},
    name:"Sample Points"
  };

  const layout2D = {
    title:`2D Function g(x) = ${exprStr}`,
    dragmode:false,
    xaxis:{range:[xStart,xEnd]},
    yaxis:{range:[Math.min(...dataset.map(p=>p.y))-1, Math.max(...dataset.map(p=>p.y))+1]}
  };

  Plotly.newPlot("function2D",[funcTrace, pointsTrace],layout2D);

  function updateTable(){
    const tbody = document.querySelector("#pointsTable tbody");
    tbody.innerHTML="";
    dataset.forEach((p,i)=>{
      const row=document.createElement("tr");
      row.innerHTML=`<td>${i+1}</td><td>${p.x.toFixed(3)}</td><td>${p.y.toFixed(3)}</td>`;
      tbody.appendChild(row);
    });
  }

  updateTable();

  document.getElementById("resetBtn").onclick = ()=>{
    generatePoints();
    pointsTrace.x = dataset.map(p=>p.x);
    pointsTrace.y = dataset.map(p=>p.y);
    layout2D.yaxis.range = [Math.min(...dataset.map(p=>p.y))-1, Math.max(...dataset.map(p=>p.y))+1];
    Plotly.react("function2D",[funcTrace, pointsTrace],layout2D);
    updateTable();
  };

  document.getElementById("randomBtn").onclick = ()=>{
    generatePoints();
    pointsTrace.x = dataset.map(p=>p.x);
    pointsTrace.y = dataset.map(p=>p.y);
    layout2D.yaxis.range = [Math.min(...dataset.map(p=>p.y))-1, Math.max(...dataset.map(p=>p.y))+1];
    Plotly.react("function2D",[funcTrace, pointsTrace],layout2D);
    updateTable();
  };

  document.getElementById("showCurveBtn").onclick = ()=>{
    Plotly.restyle("function2D",{visible:true},[0]);
  };

  // ---------------------------
  // 4. 3D SSE Surface
  // ---------------------------
  const aMin=0.5, aMax=5, aStep=0.2;
  const bMin=0.5, bMax=5, bStep=0.2;
  const aVals = math.range(aMin,aMax,aStep).toArray();
  const bVals = math.range(bMin,bMax,bStep).toArray();

  const zValues = [];
  for(let i=0;i<aVals.length;i++){
    const row=[];
    for(let j=0;j<bVals.length;j++){
      const a=aVals[i];
      const b=bVals[j];
      let sse=0;
      dataset.forEach(p=>{
        sse += Math.pow(g(a,b,p.x)-p.y,2);
      });
      row.push(sse);
    }
    zValues.push(row);
  }

  Plotly.newPlot("surfacePlot",[{
    type:"surface",
    x:aVals,
    y:bVals,
    z:zValues,
    colorscale:"Viridis"
  }],{title:`SSE Surface for ${chosen}`});

</script>
</body>
</html>
